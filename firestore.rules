rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users: Users can only read/update their own document.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // Creation/deletion handled by Cloud Functions.
    }

    // Organizations: Can only be read/written by Super Admins.
    match /organizations/{orgId} {
      allow read, write: if request.auth != null && request.auth.token.role == 'super_admin';

      // Subcollections (Tasks, Departments, etc.)
      match /{subcollection}/{docId} {
        // Admins of the specific organization can manage these resources.
        allow read, write: if request.auth != null && request.auth.token.organizationId == orgId && request.auth.token.role == 'admin';
        // Collaborators can read resources of their own organization.
        allow read: if request.auth != null && request.auth.token.organizationId == orgId && request.auth.token.role == 'collaborator';
      }
    }
    
    // Awards: Temporarily allow any authenticated user to write for debugging.
    // Admins and Super Admins can write, anyone authenticated can read.
    match /awards/{awardId} {
      allow read: if request.auth != null;
      // TEMPORARY RULE FOR DEBUGGING
      allow write: if request.auth != null;
      // ORIGINAL RULE: allow write: if request.auth.token.role == 'super_admin' || request.auth.token.role == 'admin';
    }

    // Award History: Can be read by anyone authenticated, written only by admins/super_admins
    match /awardHistory/{historyId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'super_admin' || request.auth.token.role == 'admin';
    }

    // Plans: Can be read by anyone authenticated, written only by super_admins
    match /plans/{planId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.role == 'super_admin';
    }
  }
}