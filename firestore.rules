
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Por padrão, nega todas as leituras e escritas
    match /{document=**} {
      allow read, write: if false;
    }

    // Regras da coleção de usuários
    // Permite que usuários autenticados leiam perfis
    // Permite que um usuário atualize seu próprio perfil
    // Permite que admins/super_admins gerenciem qualquer perfil
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update: if request.auth.uid == userId 
                      || request.auth.token.role in ['admin', 'super_admin'];
      allow create, delete: if request.auth.token.role in ['admin', 'super_admin'];
    }

    // Regras da coleção de organizações
    // Permite que Super Admins gerenciem todas as organizações
    // Permite que Admins leiam os dados da sua própria organização
    match /organizations/{orgId} {
      allow read: if request.auth.token.role == 'super_admin' 
                    || (request.auth.token.role == 'admin' && request.auth.token.organizationId == orgId);
      allow write: if request.auth.token.role == 'super_admin';
    }

    // Regras para subcoleções dentro de uma organização (tasks, roles, departments, etc.)
    match /organizations/{orgId}/{subcollection}/{docId} {
        // Admins da organização e super admins têm acesso total
        allow read, write: if request.auth != null && (
                            request.auth.token.role == 'super_admin' ||
                            (request.auth.token.role == 'admin' && request.auth.token.organizationId == orgId)
                          );
        // Colaboradores podem ler a maioria dos dados da sua própria organização
        allow read: if request.auth != null && 
                     request.auth.token.role == 'collaborator' && 
                     request.auth.token.organizationId == orgId;
    }
    
    // Regra específica para Colaboradores criarem/atualizarem suas participações em desafios
    match /organizations/{orgId}/challengeParticipations/{participationId} {
        allow write: if request.auth != null && request.auth.uid == request.resource.data.employeeId;
    }

    // Regras para coleções de nível raiz como 'awards' e 'plans'
    match /awards/{awardId} {
        // Qualquer usuário autenticado pode ler as premiações
        allow read: if request.auth != null;
        // Apenas admins e super admins podem criar, editar ou deletar
        allow write: if request.auth.token.role in ['admin', 'super_admin'];
    }
    
    match /plans/{planId} {
        // Qualquer usuário autenticado pode ver os planos
        allow read: if request.auth != null;
        // Apenas super admins podem gerenciar os planos
        allow write: if request.auth.token.role == 'super_admin';
    }
    
    match /awardHistory/{historyId} {
        // Qualquer usuário autenticado pode ler o histórico
        allow read: if request.auth != null;
        // Admins e super admins podem escrever no histórico (confirmar vencedores)
        allow write: if request.auth.token.role in ['admin', 'super_admin'];
    }

  }
}
